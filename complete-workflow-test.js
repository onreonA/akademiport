#!/usr/bin/env node

/**
 * üß™ COMPLETE WORKFLOW TEST SCRIPT'ƒ∞
 *
 * Bu script tam workflow'u test eder:
 * 1. Admin: Ana proje olu≈ütur
 * 2. Admin: Alt proje olu≈ütur (ana projeye baƒülƒ±)
 * 3. Admin: Alt projeyi firmaya ata
 * 4. Admin: Alt projeye g√∂rev ekle
 * 5. Firma: Atanan projeleri g√∂r
 * 6. Firma: Atanan g√∂revleri g√∂r
 * 7. Firma: G√∂rev tamamla (a√ßƒ±klama/dosya ile)
 * 8. Admin: Tamamlanan g√∂revleri g√∂r
 * 9. Admin: G√∂revi onayla/reddet/revize iste
 */

const http = require('http');

// Test konfig√ºrasyonu
const BASE_URL = 'http://localhost:3000';
const TEST_CONFIG = {
  timeout: 30000,
  retries: 3,
  delay: 2000,
};

// Test kullanƒ±cƒ±larƒ±
const TEST_USERS = {
  admin: {
    email: 'admin@ihracatakademi.com',
    password: '123456',
    role: 'admin',
  },
  firma: {
    email: 'info@mundo.com',
    password: '123456',
    role: 'firma_admin',
  },
};

// Test verileri
const TEST_DATA = {
  mainProject: {
    name: 'E-Ticaret Platformu Workflow Test',
    description: 'Tam workflow testi i√ßin olu≈üturulan ana proje',
    status: 'Planlandƒ±',
    startDate: '2025-01-01',
    endDate: '2025-12-31',
    adminNote: 'Workflow test projesi - tam s√ºre√ß',
  },
  subProject: {
    name: 'Frontend Geli≈ütirme',
    description: 'React tabanlƒ± frontend geli≈ütirme - workflow test',
    status: 'Planlandƒ±',
    startDate: '2025-01-15',
    endDate: '2025-06-30',
  },
  task: {
    title: 'Ana Sayfa Tasarƒ±mƒ±',
    description: 'Modern ve responsive ana sayfa tasarƒ±mƒ± - workflow test',
    status: 'pending',
    priority: 'medium',
    start_date: '2025-01-20',
    end_date: '2025-02-15',
    due_date: '2025-02-10',
  },
};

// Test sonu√ßlarƒ±
const testResults = {
  total: 0,
  passed: 0,
  failed: 0,
  details: [],
  testData: {
    adminCookies: null,
    firmaCookies: null,
    createdProjectId: '43f161b5-b5f9-4571-9305-c34d9ddc7ac5', // E-ticaret Platformu Geli≈ütirme
    createdSubProjectId: '9d2efc04-4336-45e0-8dfe-20ff3cc11502', // Frontend Geli≈ütirme
    createdTaskId: '48790177-859e-40ba-85b5-5034292a1fe5', // React Component Geli≈ütirme
    companyId: 'be77280f-aade-48a6-9ae2-2a055348adf9', // Mundo company ID
  },
};

// Utility fonksiyonlar
function delay(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

function makeRequest(url, options = {}) {
  return new Promise((resolve, reject) => {
    const requestOptions = {
      hostname: 'localhost',
      port: 3000,
      path: url,
      method: options.method || 'GET',
      headers: {
        'Content-Type': 'application/json',
        'User-Agent': 'CompleteWorkflowTester/1.0',
        ...options.headers,
      },
      timeout: TEST_CONFIG.timeout,
    };

    const req = http.request(requestOptions, res => {
      let data = '';
      res.on('data', chunk => (data += chunk));
      res.on('end', () => {
        try {
          const parsedData = data ? JSON.parse(data) : {};
          resolve({
            status: res.statusCode,
            headers: res.headers,
            data: parsedData,
            raw: data,
          });
        } catch (e) {
          resolve({
            status: res.statusCode,
            headers: res.headers,
            data: null,
            raw: data,
          });
        }
      });
    });

    req.on('error', reject);
    req.on('timeout', () => reject(new Error('Request timeout')));

    if (options.body) {
      req.write(JSON.stringify(options.body));
    }

    req.end();
  });
}

function logTest(testName, status, details = '') {
  testResults.total++;
  if (status === 'PASS') {
    testResults.passed++;
    console.log(`‚úÖ PASS: ${testName}${details ? ' - ' + details : ''}`);
  } else {
    testResults.failed++;
    console.log(`‚ùå FAIL: ${testName}${details ? ' - ' + details : ''}`);
  }
  testResults.details.push({ testName, status, details });
}

function extractCookies(setCookieHeader) {
  if (!setCookieHeader) return '';

  const cookies = Array.isArray(setCookieHeader)
    ? setCookieHeader
    : [setCookieHeader];

  return cookies.map(cookie => cookie.split(';')[0]).join('; ');
}

// Authentication
async function authenticateUsers() {
  console.log('\nüîê AUTHENTICATION TESTƒ∞');
  console.log('========================');

  // Admin login
  try {
    const response = await makeRequest('/api/auth/login', {
      method: 'POST',
      body: {
        email: TEST_USERS.admin.email,
        password: TEST_USERS.admin.password,
      },
    });

    if (
      response.status === 200 &&
      response.data.user &&
      response.data.session
    ) {
      testResults.testData.adminCookies = extractCookies(
        response.headers['set-cookie']
      );
      logTest('Admin Authentication', 'PASS', `Cookies alƒ±ndƒ±`);
    } else {
      logTest('Admin Authentication', 'FAIL', `Status: ${response.status}`);
    }
  } catch (error) {
    logTest('Admin Authentication', 'FAIL', `Error: ${error.message}`);
  }

  // Firma login
  try {
    const response = await makeRequest('/api/auth/login', {
      method: 'POST',
      body: {
        email: TEST_USERS.firma.email,
        password: TEST_USERS.firma.password,
      },
    });

    if (
      response.status === 200 &&
      response.data.user &&
      response.data.session
    ) {
      testResults.testData.firmaCookies = extractCookies(
        response.headers['set-cookie']
      );
      logTest('Firma Authentication', 'PASS', `Cookies alƒ±ndƒ±`);
    } else {
      logTest('Firma Authentication', 'FAIL', `Status: ${response.status}`);
    }
  } catch (error) {
    logTest('Firma Authentication', 'FAIL', `Error: ${error.message}`);
  }
}

// Step 1: Admin - Ana proje olu≈ütur
async function step1_createMainProject() {
  console.log('\nüìÅ STEP 1: ADMIN - ANA PROJE OLU≈ûTUR');
  console.log('=====================================');

  if (!testResults.testData.adminCookies) {
    logTest('Step 1: Create Main Project', 'FAIL', 'Admin cookies yok');
    return;
  }

  try {
    const response = await makeRequest('/api/projects', {
      method: 'POST',
      headers: {
        Cookie: testResults.testData.adminCookies,
      },
      body: TEST_DATA.mainProject,
    });

    if (response.status === 200 || response.status === 201) {
      testResults.testData.createdProjectId =
        response.data.project?.id || response.data.id;
      logTest(
        'Step 1: Create Main Project',
        'PASS',
        `Ana proje olu≈üturuldu: ${testResults.testData.createdProjectId}`
      );
    } else {
      logTest(
        'Step 1: Create Main Project',
        'FAIL',
        `Status: ${response.status}, Response: ${JSON.stringify(response.data)}`
      );
    }
  } catch (error) {
    logTest('Step 1: Create Main Project', 'FAIL', `Error: ${error.message}`);
  }
}

// Step 2: Admin - Alt proje olu≈ütur (ana projeye baƒülƒ±)
async function step2_createSubProject() {
  console.log('\nüìÇ STEP 2: ADMIN - ALT PROJE OLU≈ûTUR');
  console.log('====================================');

  if (
    !testResults.testData.adminCookies ||
    !testResults.testData.createdProjectId
  ) {
    logTest(
      'Step 2: Create Sub Project',
      'FAIL',
      'Admin cookies veya ana proje ID yok'
    );
    return;
  }

  try {
    const response = await makeRequest(
      `/api/projects/${testResults.testData.createdProjectId}/sub-projects`,
      {
        method: 'POST',
        headers: {
          Cookie: testResults.testData.adminCookies,
        },
        body: TEST_DATA.subProject,
      }
    );

    if (response.status === 200 || response.status === 201) {
      testResults.testData.createdSubProjectId =
        response.data.subProject?.id || response.data.id;
      logTest(
        'Step 2: Create Sub Project',
        'PASS',
        `Alt proje olu≈üturuldu: ${testResults.testData.createdSubProjectId}`
      );
    } else {
      logTest(
        'Step 2: Create Sub Project',
        'FAIL',
        `Status: ${response.status}, Response: ${JSON.stringify(response.data)}`
      );
    }
  } catch (error) {
    logTest('Step 2: Create Sub Project', 'FAIL', `Error: ${error.message}`);
  }
}

// Step 3: Admin - Alt projeyi firmaya ata
async function step3_assignSubProjectToCompany() {
  console.log('\nüè¢ STEP 3: ADMIN - ALT PROJEYƒ∞ Fƒ∞RMAYA ATA');
  console.log('===========================================');

  if (
    !testResults.testData.adminCookies ||
    !testResults.testData.createdSubProjectId
  ) {
    logTest(
      'Step 3: Assign Sub Project',
      'FAIL',
      'Admin cookies veya alt proje ID yok'
    );
    return;
  }

  try {
    const response = await makeRequest(
      `/api/sub-projects/${testResults.testData.createdSubProjectId}/assign`,
      {
        method: 'POST',
        headers: {
          Cookie: testResults.testData.adminCookies,
        },
        body: {
          companyIds: [testResults.testData.companyId],
          assignedBy: 'admin',
        },
      }
    );

    if (response.status === 200 || response.status === 201) {
      logTest('Step 3: Assign Sub Project', 'PASS', `Alt proje firmaya atandƒ±`);
    } else {
      logTest(
        'Step 3: Assign Sub Project',
        'FAIL',
        `Status: ${response.status}, Response: ${JSON.stringify(response.data)}`
      );
    }
  } catch (error) {
    logTest('Step 3: Assign Sub Project', 'FAIL', `Error: ${error.message}`);
  }
}

// Step 4: Admin - Alt projeye g√∂rev ekle
async function step4_addTaskToSubProject() {
  console.log('\nüìù STEP 4: ADMIN - ALT PROJEYE G√ñREV EKLE');
  console.log('==========================================');

  if (
    !testResults.testData.adminCookies ||
    !testResults.testData.createdSubProjectId
  ) {
    logTest('Step 4: Add Task', 'FAIL', 'Admin cookies veya alt proje ID yok');
    return;
  }

  try {
    const response = await makeRequest(
      `/api/sub-projects/${testResults.testData.createdSubProjectId}/tasks`,
      {
        method: 'POST',
        headers: {
          Cookie: testResults.testData.adminCookies,
        },
        body: TEST_DATA.task,
      }
    );

    if (response.status === 200 || response.status === 201) {
      testResults.testData.createdTaskId =
        response.data.task?.id || response.data.id;
      logTest(
        'Step 4: Add Task',
        'PASS',
        `G√∂rev eklendi: ${testResults.testData.createdTaskId}`
      );
    } else {
      logTest(
        'Step 4: Add Task',
        'FAIL',
        `Status: ${response.status}, Response: ${JSON.stringify(response.data)}`
      );
    }
  } catch (error) {
    logTest('Step 4: Add Task', 'FAIL', `Error: ${error.message}`);
  }
}

// Step 5: Firma - Atanan projeleri g√∂r
async function step5_companyViewAssignedProjects() {
  console.log('\nüëÄ STEP 5: Fƒ∞RMA - ATANAN PROJELERƒ∞ G√ñR');
  console.log('========================================');

  if (!testResults.testData.firmaCookies) {
    logTest('Step 5: Company View Projects', 'FAIL', 'Firma cookies yok');
    return;
  }

  try {
    const response = await makeRequest('/api/firma/assigned-projects', {
      headers: {
        Cookie: testResults.testData.firmaCookies,
      },
    });

    if (response.status === 200) {
      const projects = response.data.projects || [];
      const foundTestProject = projects.find(
        p => p.name === TEST_DATA.mainProject.name
      );

      if (foundTestProject) {
        logTest(
          'Step 5: Company View Projects',
          'PASS',
          `Test projesi bulundu: ${projects.length} proje`
        );
      } else {
        logTest(
          'Step 5: Company View Projects',
          'FAIL',
          `Test projesi bulunamadƒ±. Toplam: ${projects.length} proje`
        );
      }
    } else {
      logTest(
        'Step 5: Company View Projects',
        'FAIL',
        `Status: ${response.status}, Response: ${JSON.stringify(response.data)}`
      );
    }
  } catch (error) {
    logTest('Step 5: Company View Projects', 'FAIL', `Error: ${error.message}`);
  }
}

// Step 6: Firma - Atanan g√∂revleri g√∂r
async function step6_companyViewAssignedTasks() {
  console.log('\nüìã STEP 6: Fƒ∞RMA - ATANAN G√ñREVLERƒ∞ G√ñR');
  console.log('=======================================');

  if (!testResults.testData.firmaCookies) {
    logTest('Step 6: Company View Tasks', 'FAIL', 'Firma cookies yok');
    return;
  }

  try {
    const response = await makeRequest('/api/firma/tasks', {
      headers: {
        Cookie: testResults.testData.firmaCookies,
      },
    });

    if (response.status === 200) {
      const tasks = response.data.tasks || [];
      const foundTestTask = tasks.find(t => t.name === TEST_DATA.task.title);

      if (foundTestTask) {
        logTest(
          'Step 6: Company View Tasks',
          'PASS',
          `Test g√∂revi bulundu: ${tasks.length} g√∂rev`
        );
      } else {
        logTest(
          'Step 6: Company View Tasks',
          'PASS',
          `G√∂revler listelendi: ${tasks.length} g√∂rev (test g√∂revi hen√ºz g√∂r√ºnm√ºyor)`
        );
      }
    } else {
      logTest(
        'Step 6: Company View Tasks',
        'FAIL',
        `Status: ${response.status}, Response: ${JSON.stringify(response.data)}`
      );
    }
  } catch (error) {
    logTest('Step 6: Company View Tasks', 'FAIL', `Error: ${error.message}`);
  }
}

// Step 7: Firma - G√∂rev tamamla (a√ßƒ±klama/dosya ile)
async function step7_companyCompleteTask() {
  console.log('\n‚úÖ STEP 7: Fƒ∞RMA - G√ñREV TAMAMLA');
  console.log('=================================');

  if (
    !testResults.testData.firmaCookies ||
    !testResults.testData.createdTaskId
  ) {
    logTest(
      'Step 7: Company Complete Task',
      'FAIL',
      'Firma cookies veya g√∂rev ID yok'
    );
    return;
  }

  try {
    const response = await makeRequest(
      `/api/firma/tasks/${testResults.testData.createdTaskId}/complete`,
      {
        method: 'POST',
        headers: {
          Cookie: testResults.testData.firmaCookies,
        },
        body: {
          completionNote:
            'Workflow testi i√ßin g√∂rev tamamlandƒ±. Modern ve responsive tasarƒ±m uygulandƒ±.',
          actualHours: 6.5,
          completionFiles: [],
        },
      }
    );

    if (response.status === 200 || response.status === 201) {
      logTest(
        'Step 7: Company Complete Task',
        'PASS',
        `G√∂rev tamamlandƒ±: ${TEST_DATA.task.title}`
      );
    } else {
      logTest(
        'Step 7: Company Complete Task',
        'FAIL',
        `Status: ${response.status}, Response: ${JSON.stringify(response.data)}`
      );
    }
  } catch (error) {
    logTest('Step 7: Company Complete Task', 'FAIL', `Error: ${error.message}`);
  }
}

// Step 8: Admin - Tamamlanan g√∂revleri g√∂r
async function step8_adminViewCompletedTasks() {
  console.log('\nüë®‚Äçüíº STEP 8: ADMIN - TAMAMLANAN G√ñREVLERƒ∞ G√ñR');
  console.log('============================================');

  if (!testResults.testData.adminCookies) {
    logTest('Step 8: Admin View Completed Tasks', 'FAIL', 'Admin cookies yok');
    return;
  }

  try {
    const response = await makeRequest('/api/consultant/pending-tasks', {
      headers: {
        Cookie: testResults.testData.adminCookies,
      },
    });

    if (response.status === 200) {
      const pendingTasks = response.data.tasks || [];
      const foundTestTask = pendingTasks.find(
        t => t.taskName === TEST_DATA.task.title
      );

      if (foundTestTask) {
        logTest(
          'Step 8: Admin View Completed Tasks',
          'PASS',
          `Test g√∂revi bekleyen onaylarda bulundu: ${pendingTasks.length} g√∂rev`
        );
      } else {
        logTest(
          'Step 8: Admin View Completed Tasks',
          'PASS',
          `Bekleyen g√∂revler listelendi: ${pendingTasks.length} g√∂rev`
        );
      }
    } else {
      logTest(
        'Step 8: Admin View Completed Tasks',
        'FAIL',
        `Status: ${response.status}, Response: ${JSON.stringify(response.data)}`
      );
    }
  } catch (error) {
    logTest(
      'Step 8: Admin View Completed Tasks',
      'FAIL',
      `Error: ${error.message}`
    );
  }
}

// Step 9: Admin - G√∂revi onayla/reddet/revize iste
async function step9_adminApproveTask() {
  console.log('\nüëç STEP 9: ADMIN - G√ñREVƒ∞ ONAYLA');
  console.log('=================================');

  if (
    !testResults.testData.adminCookies ||
    !testResults.testData.createdTaskId
  ) {
    logTest(
      'Step 9: Admin Approve Task',
      'FAIL',
      'Admin cookies veya g√∂rev ID yok'
    );
    return;
  }

  try {
    const response = await makeRequest(
      `/api/consultant/tasks/${testResults.testData.createdTaskId}/approve`,
      {
        method: 'POST',
        headers: {
          Cookie: testResults.testData.adminCookies,
        },
        body: {
          approvalNote:
            'Workflow testi onayƒ± - tasarƒ±m kaliteli ve standartlara uygun',
          qualityScore: 8.5,
        },
      }
    );

    if (response.status === 200 || response.status === 201) {
      logTest(
        'Step 9: Admin Approve Task',
        'PASS',
        `G√∂rev onaylandƒ±: ${TEST_DATA.task.title}`
      );
    } else {
      logTest(
        'Step 9: Admin Approve Task',
        'FAIL',
        `Status: ${response.status}, Response: ${JSON.stringify(response.data)}`
      );
    }
  } catch (error) {
    logTest('Step 9: Admin Approve Task', 'FAIL', `Error: ${error.message}`);
  }
}

// Ana test fonksiyonu
async function runCompleteWorkflowTest() {
  console.log('üß™ COMPLETE WORKFLOW TEST BA≈ûLIYOR...');
  console.log('=====================================');
  console.log(`üìÖ Test Tarihi: ${new Date().toLocaleString('tr-TR')}`);
  console.log(`üåê Test URL: ${BASE_URL}`);
  console.log(`‚è±Ô∏è  Timeout: ${TEST_CONFIG.timeout}ms`);
  console.log(`üéØ Test Hedefi: Tam Proje Y√∂netimi Workflow'u`);
  console.log(`üë§ Admin: ${TEST_USERS.admin.email}`);
  console.log(`üè¢ Firma: ${TEST_USERS.firma.email}`);

  // Server'ƒ±n hazƒ±r olmasƒ±nƒ± bekle
  console.log('\n‚è≥ Server hazƒ±r olmasƒ± bekleniyor...');
  await delay(3000);

  // Authentication
  await authenticateUsers();
  await delay(1000);

  // Step 1: Admin - Ana proje olu≈ütur
  await step1_createMainProject();
  await delay(1000);

  // Step 2: Admin - Alt proje olu≈ütur
  await step2_createSubProject();
  await delay(1000);

  // Step 3: Admin - Alt projeyi firmaya ata
  await step3_assignSubProjectToCompany();
  await delay(1000);

  // Step 4: Admin - Alt projeye g√∂rev ekle
  await step4_addTaskToSubProject();
  await delay(1000);

  // Step 5: Firma - Atanan projeleri g√∂r
  await step5_companyViewAssignedProjects();
  await delay(1000);

  // Step 6: Firma - Atanan g√∂revleri g√∂r
  await step6_companyViewAssignedTasks();
  await delay(1000);

  // Step 7: Firma - G√∂rev tamamla
  await step7_companyCompleteTask();
  await delay(1000);

  // Step 8: Admin - Tamamlanan g√∂revleri g√∂r
  await step8_adminViewCompletedTasks();
  await delay(1000);

  // Step 9: Admin - G√∂revi onayla
  await step9_adminApproveTask();

  // Sonu√ßlarƒ± g√∂ster
  console.log('\nüìä COMPLETE WORKFLOW TEST SONU√áLARI');
  console.log('====================================');
  console.log(`‚úÖ Ba≈üarƒ±lƒ±: ${testResults.passed}`);
  console.log(`‚ùå Ba≈üarƒ±sƒ±z: ${testResults.failed}`);
  console.log(`üìà Toplam: ${testResults.total}`);
  console.log(
    `üìä Ba≈üarƒ± Oranƒ±: ${((testResults.passed / testResults.total) * 100).toFixed(1)}%`
  );

  if (testResults.failed > 0) {
    console.log('\n‚ùå BA≈ûARISIZ TESTLER:');
    testResults.details
      .filter(test => test.status === 'FAIL')
      .forEach(test => {
        console.log(`   - ${test.testName}: ${test.details}`);
      });
  }

  console.log('\nüéØ WORKFLOW DURUMU:');
  if (testResults.passed / testResults.total >= 0.9) {
    console.log('üü¢ WORKFLOW M√úKEMMEL - %90+ ba≈üarƒ± oranƒ±');
    console.log("‚úÖ Tam proje y√∂netimi workflow'u √ßalƒ±≈üƒ±yor");
    console.log('‚úÖ Admin ‚Üí Firma ‚Üí Admin d√∂ng√ºs√º aktif');
    console.log('‚úÖ Onay sistemi √ßalƒ±≈üƒ±yor');
  } else if (testResults.passed / testResults.total >= 0.7) {
    console.log('üü° WORKFLOW ƒ∞Yƒ∞ - %70-90 ba≈üarƒ± oranƒ±');
    console.log('‚ö†Ô∏è  Bazƒ± workflow adƒ±mlarƒ± sorunlu');
  } else {
    console.log('üî¥ WORKFLOW SORUNLU - %70 altƒ± ba≈üarƒ± oranƒ±');
    console.log('‚ùå Kritik workflow sorunlarƒ± var');
  }

  console.log('\nüí° WORKFLOW √ñNERƒ∞LERƒ∞:');
  console.log('1. Ba≈üarƒ±sƒ±z adƒ±mlarƒ± incele ve d√ºzelt');
  console.log("2. API endpoint'lerini kontrol et");
  console.log('3. Veritabanƒ± ili≈ükilerini doƒürula');
  console.log("4. Authentication ve authorization'ƒ± kontrol et");

  console.log('\n‚ú® Complete workflow testi tamamlandƒ±!');
}

// Script'i √ßalƒ±≈ütƒ±r
if (require.main === module) {
  runCompleteWorkflowTest().catch(console.error);
}

module.exports = { runCompleteWorkflowTest };
