#!/usr/bin/env node

/**
 * üß™ WORKFLOW TESTER SCRIPT'ƒ∞
 *
 * Bu script proje y√∂netimi workflow'unu adƒ±m adƒ±m test eder:
 * 1. Admin ‚Üí Ana proje olu≈üturma
 * 2. Admin ‚Üí Alt proje tanƒ±mlama
 * 3. Admin ‚Üí Firmalara √ßoklu atama
 * 4. Firma ‚Üí Atanan projeleri g√∂rme
 * 5. Firma ‚Üí G√∂rev tamamlama
 * 6. Danƒ±≈üman ‚Üí Onay sistemi
 * 7. Admin ‚Üí ƒ∞lerleme takibi
 * 8. Sistem ‚Üí √áoklu firma kar≈üƒ±la≈ütƒ±rmasƒ±
 */

const http = require('http');

// Test konfig√ºrasyonu
const BASE_URL = 'http://localhost:3000';
const TEST_CONFIG = {
  timeout: 15000,
  retries: 3,
  delay: 2000,
};

// Test kullanƒ±cƒ±larƒ±
const TEST_USERS = {
  admin: {
    email: 'admin@ihracatakademi.com',
    password: '123456',
    role: 'admin',
  },
  firma: {
    email: 'info@mundo.com',
    password: '123456',
    role: 'firma_admin',
  },
};

// Test verileri
const TEST_DATA = {
  mainProject: {
    name: 'E-Ticaret Platformu Test Projesi',
    description: 'Workflow testi i√ßin olu≈üturulan ana proje',
    status: 'Planlandƒ±',
    startDate: '2025-01-01',
    endDate: '2025-12-31',
    adminNote: 'Workflow test projesi',
  },
  subProjects: [
    {
      name: 'Frontend Geli≈ütirme',
      description: 'React tabanlƒ± frontend geli≈ütirme',
      priority: 'high',
    },
    {
      name: 'Backend API',
      description: 'Node.js API geli≈ütirme',
      priority: 'high',
    },
    {
      name: 'Test ve Deployment',
      description: 'Test senaryolarƒ± ve deployment',
      priority: 'medium',
    },
  ],
  tasks: [
    {
      name: 'Ana Sayfa Tasarƒ±mƒ±',
      description: 'Modern ve responsive ana sayfa',
      priority: 'high',
      estimated_hours: 8,
    },
    {
      name: '√úr√ºn Listeleme',
      description: '√úr√ºn kartlarƒ± ve filtreleme',
      priority: 'high',
      estimated_hours: 12,
    },
    {
      name: 'API Endpoint Tasarƒ±mƒ±',
      description: 'RESTful API tasarƒ±mƒ±',
      priority: 'high',
      estimated_hours: 16,
    },
  ],
};

// Test sonu√ßlarƒ±
const testResults = {
  total: 0,
  passed: 0,
  failed: 0,
  details: [],
  testData: {
    adminToken: null,
    firmaToken: null,
    createdProjectId: null,
    createdSubProjectIds: [],
    createdTaskIds: [],
    assignmentIds: [],
  },
};

// Utility fonksiyonlar
function delay(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

function makeRequest(url, options = {}) {
  return new Promise((resolve, reject) => {
    const requestOptions = {
      hostname: 'localhost',
      port: 3000,
      path: url,
      method: options.method || 'GET',
      headers: {
        'Content-Type': 'application/json',
        'User-Agent': 'WorkflowTester/1.0',
        ...options.headers,
      },
      timeout: TEST_CONFIG.timeout,
    };

    const req = http.request(requestOptions, res => {
      let data = '';
      res.on('data', chunk => (data += chunk));
      res.on('end', () => {
        try {
          const parsedData = data ? JSON.parse(data) : {};
          resolve({
            status: res.statusCode,
            headers: res.headers,
            data: parsedData,
            raw: data,
          });
        } catch (e) {
          resolve({
            status: res.statusCode,
            headers: res.headers,
            data: null,
            raw: data,
          });
        }
      });
    });

    req.on('error', reject);
    req.on('timeout', () => reject(new Error('Request timeout')));

    if (options.body) {
      req.write(JSON.stringify(options.body));
    }

    req.end();
  });
}

function logTest(testName, status, details = '') {
  testResults.total++;
  if (status === 'PASS') {
    testResults.passed++;
    console.log(`‚úÖ PASS: ${testName}${details ? ' - ' + details : ''}`);
  } else {
    testResults.failed++;
    console.log(`‚ùå FAIL: ${testName}${details ? ' - ' + details : ''}`);
  }
  testResults.details.push({ testName, status, details });
}

// Authentication
async function authenticateUsers() {
  console.log('\nüîê AUTHENTICATION TESTƒ∞');
  console.log('========================');

  // Admin login
  try {
    const response = await makeRequest('/api/auth/login', {
      method: 'POST',
      body: {
        email: TEST_USERS.admin.email,
        password: TEST_USERS.admin.password,
      },
    });

    if (
      response.status === 200 &&
      response.data.user &&
      response.data.session
    ) {
      testResults.testData.adminToken = response.data.session.access_token;
      logTest('Admin Authentication', 'PASS', `Token alƒ±ndƒ±`);
    } else {
      logTest('Admin Authentication', 'FAIL', `Status: ${response.status}`);
    }
  } catch (error) {
    logTest('Admin Authentication', 'FAIL', `Error: ${error.message}`);
  }

  // Firma login
  try {
    const response = await makeRequest('/api/auth/login', {
      method: 'POST',
      body: {
        email: TEST_USERS.firma.email,
        password: TEST_USERS.firma.password,
      },
    });

    if (
      response.status === 200 &&
      response.data.user &&
      response.data.session
    ) {
      testResults.testData.firmaToken = response.data.session.access_token;
      logTest('Firma Authentication', 'PASS', `Token alƒ±ndƒ±`);
    } else {
      logTest('Firma Authentication', 'FAIL', `Status: ${response.status}`);
    }
  } catch (error) {
    logTest('Firma Authentication', 'FAIL', `Error: ${error.message}`);
  }
}

// Test 1: Admin tarafƒ±ndan ana proje olu≈üturma
async function testMainProjectCreation() {
  console.log('\nüìÅ TEST 1: ANA PROJE OLU≈ûTURMA');
  console.log('================================');

  if (!testResults.testData.adminToken) {
    logTest('Main Project Creation', 'FAIL', 'Admin token yok');
    return;
  }

  try {
    const response = await makeRequest('/api/projects', {
      method: 'POST',
      headers: { Authorization: `Bearer ${testResults.testData.adminToken}` },
      body: TEST_DATA.mainProject,
    });

    if (response.status === 200 || response.status === 201) {
      testResults.testData.createdProjectId =
        response.data.id || response.data.project?.id;
      logTest(
        'Main Project Creation',
        'PASS',
        `Proje olu≈üturuldu: ${testResults.testData.createdProjectId}`
      );
    } else {
      logTest(
        'Main Project Creation',
        'FAIL',
        `Status: ${response.status}, Response: ${JSON.stringify(response.data)}`
      );
    }
  } catch (error) {
    logTest('Main Project Creation', 'FAIL', `Error: ${error.message}`);
  }
}

// Test 2: Alt proje tanƒ±mlama
async function testSubProjectCreation() {
  console.log('\nüìÇ TEST 2: ALT PROJE TANIMLAMA');
  console.log('===============================');

  if (
    !testResults.testData.adminToken ||
    !testResults.testData.createdProjectId
  ) {
    logTest(
      'Sub Project Creation',
      'FAIL',
      'Admin token veya ana proje ID yok'
    );
    return;
  }

  for (const [index, subProject] of TEST_DATA.subProjects.entries()) {
    try {
      const response = await makeRequest(
        `/api/projects/${testResults.testData.createdProjectId}/sub-projects`,
        {
          method: 'POST',
          headers: {
            Authorization: `Bearer ${testResults.testData.adminToken}`,
          },
          body: subProject,
        }
      );

      if (response.status === 200 || response.status === 201) {
        const subProjectId = response.data.id || response.data.sub_project?.id;
        testResults.testData.createdSubProjectIds.push(subProjectId);
        logTest(
          `Sub Project ${index + 1} Creation`,
          'PASS',
          `${subProject.name} olu≈üturuldu: ${subProjectId}`
        );
      } else {
        logTest(
          `Sub Project ${index + 1} Creation`,
          'FAIL',
          `Status: ${response.status}, Response: ${JSON.stringify(response.data)}`
        );
      }
    } catch (error) {
      logTest(
        `Sub Project ${index + 1} Creation`,
        'FAIL',
        `Error: ${error.message}`
      );
    }
  }
}

// Test 3: Firmalara √ßoklu atama
async function testMultiCompanyAssignment() {
  console.log('\nüè¢ TEST 3: √áOKLU Fƒ∞RMA ATAMASI');
  console.log('===============================');

  if (
    !testResults.testData.adminToken ||
    !testResults.testData.createdProjectId
  ) {
    logTest(
      'Multi Company Assignment',
      'FAIL',
      'Admin token veya proje ID yok'
    );
    return;
  }

  // Ana projeyi firmaya ata
  try {
    const response = await makeRequest(
      `/api/projects/${testResults.testData.createdProjectId}/assign`,
      {
        method: 'POST',
        headers: { Authorization: `Bearer ${testResults.testData.adminToken}` },
        body: {
          companyIds: ['6fcc9e92-4169-4b06-9c2f-a8c6cc284d73'], // Mundo company ID
          assignedBy: testResults.testData.adminToken,
        },
      }
    );

    if (response.status === 200 || response.status === 201) {
      logTest('Main Project Assignment', 'PASS', 'Ana proje firmaya atandƒ±');
    } else {
      logTest(
        'Main Project Assignment',
        'FAIL',
        `Status: ${response.status}, Response: ${JSON.stringify(response.data)}`
      );
    }
  } catch (error) {
    logTest('Main Project Assignment', 'FAIL', `Error: ${error.message}`);
  }

  // Alt projeleri firmaya ata
  for (const [
    index,
    subProjectId,
  ] of testResults.testData.createdSubProjectIds.entries()) {
    try {
      const response = await makeRequest(
        `/api/sub-projects/${subProjectId}/assign`,
        {
          method: 'POST',
          headers: {
            Authorization: `Bearer ${testResults.testData.adminToken}`,
          },
          body: {
            companyIds: ['6fcc9e92-4169-4b06-9c2f-a8c6cc284d73'],
            assignedBy: testResults.testData.adminToken,
          },
        }
      );

      if (response.status === 200 || response.status === 201) {
        logTest(
          `Sub Project ${index + 1} Assignment`,
          'PASS',
          `Alt proje ${index + 1} firmaya atandƒ±`
        );
      } else {
        logTest(
          `Sub Project ${index + 1} Assignment`,
          'FAIL',
          `Status: ${response.status}, Response: ${JSON.stringify(response.data)}`
        );
      }
    } catch (error) {
      logTest(
        `Sub Project ${index + 1} Assignment`,
        'FAIL',
        `Error: ${error.message}`
      );
    }
  }
}

// Test 4: Firma tarafƒ±ndan atanan projeleri g√∂rme
async function testCompanyProjectView() {
  console.log('\nüëÄ TEST 4: Fƒ∞RMA PROJE G√ñR√úNT√úLEME');
  console.log('===================================');

  if (!testResults.testData.firmaToken) {
    logTest('Company Project View', 'FAIL', 'Firma token yok');
    return;
  }

  try {
    const response = await makeRequest('/api/firma/assigned-projects', {
      headers: { Authorization: `Bearer ${testResults.testData.firmaToken}` },
    });

    if (response.status === 200) {
      const projects = response.data.projects || [];
      const foundTestProject = projects.find(
        p => p.name === TEST_DATA.mainProject.name
      );

      if (foundTestProject) {
        logTest(
          'Company Project View',
          'PASS',
          `Test projesi bulundu: ${projects.length} proje`
        );
      } else {
        logTest(
          'Company Project View',
          'FAIL',
          `Test projesi bulunamadƒ±. Toplam: ${projects.length} proje`
        );
      }
    } else {
      logTest(
        'Company Project View',
        'FAIL',
        `Status: ${response.status}, Response: ${JSON.stringify(response.data)}`
      );
    }
  } catch (error) {
    logTest('Company Project View', 'FAIL', `Error: ${error.message}`);
  }
}

// Test 5: G√∂rev tamamlama
async function testTaskCompletion() {
  console.log('\n‚úÖ TEST 5: G√ñREV TAMAMLAMA');
  console.log('============================');

  if (!testResults.testData.firmaToken) {
    logTest('Task Completion', 'FAIL', 'Firma token yok');
    return;
  }

  // √ñnce g√∂revleri listele
  try {
    const response = await makeRequest('/api/firma/tasks', {
      headers: { Authorization: `Bearer ${testResults.testData.firmaToken}` },
    });

    if (response.status === 200) {
      const tasks = response.data.tasks || [];
      logTest('Task Listing', 'PASS', `${tasks.length} g√∂rev bulundu`);

      // ƒ∞lk g√∂revi tamamla
      if (tasks.length > 0) {
        const firstTask = tasks[0];
        try {
          const completionResponse = await makeRequest(
            `/api/firma/tasks/${firstTask.id}/complete`,
            {
              method: 'POST',
              headers: {
                Authorization: `Bearer ${testResults.testData.firmaToken}`,
              },
              body: {
                completionNote: 'Workflow testi i√ßin tamamlandƒ±',
                actualHours: 4.5,
                completionFiles: [],
              },
            }
          );

          if (
            completionResponse.status === 200 ||
            completionResponse.status === 201
          ) {
            logTest(
              'Task Completion',
              'PASS',
              `G√∂rev tamamlandƒ±: ${firstTask.name}`
            );
          } else {
            logTest(
              'Task Completion',
              'FAIL',
              `Status: ${completionResponse.status}, Response: ${JSON.stringify(completionResponse.data)}`
            );
          }
        } catch (error) {
          logTest('Task Completion', 'FAIL', `Error: ${error.message}`);
        }
      } else {
        logTest('Task Completion', 'FAIL', 'Tamamlanacak g√∂rev yok');
      }
    } else {
      logTest(
        'Task Listing',
        'FAIL',
        `Status: ${response.status}, Response: ${JSON.stringify(response.data)}`
      );
    }
  } catch (error) {
    logTest('Task Listing', 'FAIL', `Error: ${error.message}`);
  }
}

// Test 6: Danƒ±≈üman onay sistemi
async function testConsultantApproval() {
  console.log('\nüë®‚Äçüíº TEST 6: DANI≈ûMAN ONAY Sƒ∞STEMƒ∞');
  console.log('==================================');

  if (!testResults.testData.adminToken) {
    logTest('Consultant Approval', 'FAIL', 'Admin token yok');
    return;
  }

  // Bekleyen onaylarƒ± listele
  try {
    const response = await makeRequest('/api/consultant/pending-tasks', {
      headers: { Authorization: `Bearer ${testResults.testData.adminToken}` },
    });

    if (response.status === 200) {
      const pendingTasks = response.data.tasks || [];
      logTest(
        'Pending Tasks Listing',
        'PASS',
        `${pendingTasks.length} bekleyen g√∂rev`
      );

      // ƒ∞lk bekleyen g√∂revi onayla
      if (pendingTasks.length > 0) {
        const firstTask = pendingTasks[0];
        try {
          const approvalResponse = await makeRequest(
            `/api/consultant/tasks/${firstTask.id}/approve`,
            {
              method: 'POST',
              headers: {
                Authorization: `Bearer ${testResults.testData.adminToken}`,
              },
              body: {
                approvalNote: 'Workflow testi onayƒ±',
                qualityScore: 8.5,
              },
            }
          );

          if (
            approvalResponse.status === 200 ||
            approvalResponse.status === 201
          ) {
            logTest(
              'Task Approval',
              'PASS',
              `G√∂rev onaylandƒ±: ${firstTask.name}`
            );
          } else {
            logTest(
              'Task Approval',
              'FAIL',
              `Status: ${approvalResponse.status}, Response: ${JSON.stringify(approvalResponse.data)}`
            );
          }
        } catch (error) {
          logTest('Task Approval', 'FAIL', `Error: ${error.message}`);
        }
      } else {
        logTest('Task Approval', 'FAIL', 'Onaylanacak g√∂rev yok');
      }
    } else {
      logTest(
        'Pending Tasks Listing',
        'FAIL',
        `Status: ${response.status}, Response: ${JSON.stringify(response.data)}`
      );
    }
  } catch (error) {
    logTest('Pending Tasks Listing', 'FAIL', `Error: ${error.message}`);
  }
}

// Test 7: ƒ∞lerleme takip dashboard
async function testProgressDashboard() {
  console.log('\nüìä TEST 7: ƒ∞LERLEME TAKƒ∞P DASHBOARD');
  console.log('====================================');

  // Admin progress dashboard
  if (testResults.testData.adminToken) {
    try {
      const response = await makeRequest('/api/admin/progress', {
        headers: { Authorization: `Bearer ${testResults.testData.adminToken}` },
      });

      if (response.status === 200) {
        logTest(
          'Admin Progress Dashboard',
          'PASS',
          'Admin ilerleme verileri alƒ±ndƒ±'
        );
      } else {
        logTest(
          'Admin Progress Dashboard',
          'FAIL',
          `Status: ${response.status}`
        );
      }
    } catch (error) {
      logTest('Admin Progress Dashboard', 'FAIL', `Error: ${error.message}`);
    }
  }

  // Firma progress dashboard
  if (testResults.testData.firmaToken) {
    try {
      const response = await makeRequest('/api/firma/progress', {
        headers: { Authorization: `Bearer ${testResults.testData.firmaToken}` },
      });

      if (response.status === 200) {
        logTest(
          'Firma Progress Dashboard',
          'PASS',
          'Firma ilerleme verileri alƒ±ndƒ±'
        );
      } else {
        logTest(
          'Firma Progress Dashboard',
          'FAIL',
          `Status: ${response.status}`
        );
      }
    } catch (error) {
      logTest('Firma Progress Dashboard', 'FAIL', `Error: ${error.message}`);
    }
  }
}

// Test 8: √áoklu firma ilerleme kar≈üƒ±la≈ütƒ±rmasƒ±
async function testMultiCompanyProgress() {
  console.log('\nüîÑ TEST 8: √áOKLU Fƒ∞RMA KAR≈ûILA≈ûTIRMASI');
  console.log('======================================');

  if (!testResults.testData.adminToken) {
    logTest('Multi Company Progress', 'FAIL', 'Admin token yok');
    return;
  }

  try {
    const response = await makeRequest('/api/progress/dashboard', {
      headers: { Authorization: `Bearer ${testResults.testData.adminToken}` },
    });

    if (response.status === 200) {
      const data = response.data;
      const companyCount = data.companyPerformance?.length || 0;
      const projectCount = data.projectProgress?.length || 0;

      logTest(
        'Multi Company Progress',
        'PASS',
        `${companyCount} firma, ${projectCount} proje kar≈üƒ±la≈ütƒ±rmasƒ±`
      );
    } else {
      logTest('Multi Company Progress', 'FAIL', `Status: ${response.status}`);
    }
  } catch (error) {
    logTest('Multi Company Progress', 'FAIL', `Error: ${error.message}`);
  }
}

// Ana test fonksiyonu
async function runWorkflowTest() {
  console.log('üß™ WORKFLOW TESTER BA≈ûLIYOR...');
  console.log('===============================');
  console.log(`üìÖ Test Tarihi: ${new Date().toLocaleString('tr-TR')}`);
  console.log(`üåê Test URL: ${BASE_URL}`);
  console.log(`‚è±Ô∏è  Timeout: ${TEST_CONFIG.timeout}ms`);
  console.log(`üéØ Test Hedefi: Proje Y√∂netimi Workflow'u`);

  // Server'ƒ±n hazƒ±r olmasƒ±nƒ± bekle
  console.log('\n‚è≥ Server hazƒ±r olmasƒ± bekleniyor...');
  await delay(3000);

  // Authentication
  await authenticateUsers();

  // Test 1: Ana proje olu≈üturma
  await testMainProjectCreation();
  await delay(1000);

  // Test 2: Alt proje tanƒ±mlama
  await testSubProjectCreation();
  await delay(1000);

  // Test 3: √áoklu firma atamasƒ±
  await testMultiCompanyAssignment();
  await delay(1000);

  // Test 4: Firma proje g√∂r√ºnt√ºleme
  await testCompanyProjectView();
  await delay(1000);

  // Test 5: G√∂rev tamamlama
  await testTaskCompletion();
  await delay(1000);

  // Test 6: Danƒ±≈üman onay sistemi
  await testConsultantApproval();
  await delay(1000);

  // Test 7: ƒ∞lerleme takip dashboard
  await testProgressDashboard();
  await delay(1000);

  // Test 8: √áoklu firma kar≈üƒ±la≈ütƒ±rmasƒ±
  await testMultiCompanyProgress();

  // Sonu√ßlarƒ± g√∂ster
  console.log('\nüìä WORKFLOW TEST SONU√áLARI');
  console.log('===========================');
  console.log(`‚úÖ Ba≈üarƒ±lƒ±: ${testResults.passed}`);
  console.log(`‚ùå Ba≈üarƒ±sƒ±z: ${testResults.failed}`);
  console.log(`üìà Toplam: ${testResults.total}`);
  console.log(
    `üìä Ba≈üarƒ± Oranƒ±: ${((testResults.passed / testResults.total) * 100).toFixed(1)}%`
  );

  if (testResults.failed > 0) {
    console.log('\n‚ùå BA≈ûARISIZ TESTLER:');
    testResults.details
      .filter(test => test.status === 'FAIL')
      .forEach(test => {
        console.log(`   - ${test.testName}: ${test.details}`);
      });
  }

  console.log('\nüéØ WORKFLOW DURUMU:');
  if (testResults.passed / testResults.total >= 0.8) {
    console.log('üü¢ WORKFLOW HAZIR - %80+ ba≈üarƒ± oranƒ±');
    console.log('‚úÖ T√ºm workflow adƒ±mlarƒ± √ßalƒ±≈üƒ±yor');
    console.log('‚úÖ Proje y√∂netimi sistemi aktif');
    console.log('‚úÖ √áoklu firma desteƒüi √ßalƒ±≈üƒ±yor');
  } else if (testResults.passed / testResults.total >= 0.6) {
    console.log('üü° WORKFLOW KISMEN HAZIR - %60-80 ba≈üarƒ± oranƒ±');
    console.log('‚ö†Ô∏è  Bazƒ± workflow adƒ±mlarƒ± sorunlu');
  } else {
    console.log('üî¥ WORKFLOW SORUNLU - %60 altƒ± ba≈üarƒ± oranƒ±');
    console.log('‚ùå Kritik workflow sorunlarƒ± var');
  }

  console.log('\nüí° WORKFLOW √ñNERƒ∞LERƒ∞:');
  console.log('1. Ba≈üarƒ±sƒ±z testleri incele ve d√ºzelt');
  console.log("2. API endpoint'lerini kontrol et");
  console.log('3. Veritabanƒ± ili≈ükilerini doƒürula');
  console.log("4. Authentication token'larƒ±nƒ± kontrol et");

  console.log('\n‚ú® Workflow testi tamamlandƒ±!');
}

// Script'i √ßalƒ±≈ütƒ±r
if (require.main === module) {
  runWorkflowTest().catch(console.error);
}

module.exports = { runWorkflowTest };
